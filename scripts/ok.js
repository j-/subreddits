/*!
 * ok.js: Model/View/Controller framework
 * @module ok
 */

(function(e,t,n,r){typeof define=="function"&&define.amd?define("ok",["underscore"],e):typeof module!="undefined"&&typeof require=="function"?(n=require("underscore"),r=e(n,t),module.exports=r):(r=e(t._,t),t.ok=r,t.okaylib=r)})(function(e,t){var n={VERSION:"0.5.6"};if(!e)throw new Error("ok relies on underscore (underscorejs.org)");var r=t?t.ok:null;n.noConflict=t?function(){return t.ok=r,n}:e.constant(n);var i=Array.prototype,s=Object.prototype,o=Function.prototype,u=function(e,t,n){return i.slice.call(e,t,n)},a=function(e,t){return s.hasOwnProperty.call(e,t)},f=function(e){return s.toString.call(e)==="[object Object]"},l="add",c="remove",h="change",p="sort";n.inherits=function(e,t){var n=function(){this.constructor=e};n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype},n.extendClass=function(t){var r,i,s,o=u(arguments,1),f={},l=e.reduce(o,function(t,n){return typeof n=="function"&&(e.extend(f,n),n=n.prototype),e.extend(t,n)},{}),c=n.mergePrototypes(t.prototype,l),h=l&&a(l,"constructor")?l.constructor:function(){return t.apply(this,arguments)};return n.inherits(h,t),e.extend(h,t),e.extend(h,f),e.extend(h.prototype,l),e.extend(h.prototype,c),h.fn=h.prototype,h.__super__=t.prototype,h},n.extendThisClass=function(){var e=u(arguments);return e.unshift(this),n.extendClass.apply(this,e)},n.getSuper=function(e){var t=typeof e=="function"?e:e.constructor,n=t.__super__,r=n?n.constructor:Object;return r},n.getImplementor=function(t,r){var i=typeof t=="function"?t:t.constructor,o;return i===Object?a(s,r)?Object:null:e.isObject(t)&&a(t,r)?i:a(i.prototype,r)?i:(o=n.getSuper(i),n.getImplementor(o,r))},n.sup=function(t,r){var i,s,o=this.constructor,u=this.__currentSuper__?n.getSuper(this.__currentSuper__):n.getSuper(o);return this.__currentSuper__=u,typeof t=="string"?(u=n.getImplementor(u,t),i=u&&u.prototype[t],s=typeof i=="function"?i.apply(this,r):undefined):e.isArray(t)||e.isArguments(t)?s=u.apply(this,t):s=u,delete this.__currentSuper__,s},n.createWithArguments=function(e,t){return t=u(t),t.unshift(null),new(o.bind.apply(e,t))},n.createThisWithArguments=function(e){return n.createWithArguments(this,e)},n.create=function(e){var t=u(arguments,1);return n.createWithArguments(e,t)},n.createThis=function(){return n.createWithArguments(this,arguments)},n.include=function(t){return e.extend(this,t)},n.cloneThis=function(){var e,t=this.constructor,r=n.createThis.apply(t,arguments);return typeof this.get=="function"&&typeof r.set=="function"&&(e=this.get(),r.set(e)),r},n.toArray=function(t){var n=[];return t===undefined||t===null?n.push(t):typeof t.forEach=="function"?t.forEach(function(e){n.push(e)}):typeof t.length=="number"?e.forEach(u(t),function(e){n.push(e)}):n.push(t),n},n.mergeValues=function(){return e.any(arguments,f)?e.reduce(arguments,function(t,n){return e.extend(t,n)},{}):i.concat.apply([],e.without(arguments,null,undefined))},n.mergePrototypes=function(t,r){var i,s={};return t=t||{},r=r||{},i=e.uniq(n.mergeValues(t.mergeProperties,r.mergeProperties)),e.forEach(i,function(e){s[e]=n.mergeValues(t[e],r[e])}),s},n.Events=function(){};var d=0;n.Events.prototype={on:function(e,t,n){this._events=this._events||{};var r=this._events[e]||(this._events[e]=[]);r.push([t,n])},listenTo:function(e,t,n,r){var i=this._listeningTo||(this._listeningTo={}),s=e._listenId||(e._listenId=d++);i[s]=e,!n&&typeof t=="object"&&(n=this),r||(r=this),e.on(t,n,r)},off:function(e,t){this._events=this._events||{};var n=this._events[e];if(n)for(var r=0,i=n.length;r<i;r++)n[r][0]===t&&(n.splice(r,1),r--,i--)},stopListening:function(e,t,n){var r=this._listeningTo;if(!r)return;var i=!t&&!n;!n&&typeof t=="object"&&(n=this),e&&((r={})[e._listenId]=e);for(var s in r)e=r[s],e.off(t,n,this),i&&delete this._listeningTo[s]},trigger:function(e){this._events=this._events||{};var t=this._events[e];if(t)for(var n=0,r=t.length;n<r;n++)t[n][0].apply(t[n][1]||this,u(arguments,1))}},n.Events.fn=n.Events.prototype,n.Base=function(){var t=u(arguments);this.init&&this.init.apply(this,t)},n.Base.fn=n.Base.prototype,e.extend(n.Base.fn,n.Events.fn),n.Base.fn.init=function(){},n.Base.fn.clone=n.cloneThis,n.Base.fn.sup=n.sup,n.Base.fn.mergeProperties=["mergeProperties"],n.Base.fn.include=n.include,n.Base.include=n.include,n.Base.create=n.createThis,n.Base.extend=n.extendThisClass,n.Base.toString=function(e){var t=String(this.name),r;return t?r=e?"(subclass of "+t+")":t:r=n.getSuper(this).toString(this),r},n.Mixin=n.Base.extend({constructor:function(r){var i,s={};return e.forEach(r,function(e,t){typeof e=="function"?s[t]=function(){var t=u(arguments);return t.unshift(this),e.apply(i,t)}:s[t]=e}),i=n.Base.extend(s),e.extend(i,r),delete i.fn.constructor,i}}),n.Data=n.Base.extend({constructor:function(){return n.Base.apply(this,arguments)},get:function(){return null},set:function(){}}),n.Property=n.Data.extend({_value:null,defaultValue:null,constructor:function(t){arguments.length?this.set(t):this.set(this.defaultValue),n.Data.apply(this,arguments)},getValue:function(){return this._value},setValue:function(e){var t=this._value;t!==e&&(this._value=e,this.trigger(h,this,e,t))},get:function(){return this.getValue()},set:function(e){this.setValue(e)}}),n.Map=n.Data.extend({properties:null,schema:null,defaults:null,defaultConstructor:n.Property,constructor:function(t){n.Data.apply(this,arguments);var r=this.getDefaults();this.properties||(this.properties={}),r&&this.initProperties(r),t&&this.setMap(t)},destroy:function(){var t=this.properties,n;e.forEach(t,function(e,t){e=this.getProperty(t),this.stopListening(e,h)},this)},getDefaults:function(){var e=this.constructor.prototype.defaults;return typeof e=="function"?e.apply(this):e},initProperties:function(e){e=e||{};for(var t in e)this.initProperty(t,e[t],e)},initProperty:function(e,t){var n=this.getProperty(e),r,i=this;return n||(r=this.getConstructor(e,t),n=new r,n=this.setProperty(e,n)),typeof t!="undefined"&&n.set(t),n},change:function(e,t,n){this.trigger(h,e,t,n)},getConstructor:function(e,t){var n=this.schema&&this.schema[e];return n||this.defaultConstructor},get:function(e){var t=arguments,n=t.length;return n===0?this.getMap():n===1?this.getValue(e):this.getValues.apply(this,t)},getMap:function(){var t=this.properties,n=e.map(t,function(e,t){return[t,e.get()]}),r=e.object(n);return r},getValue:function(e){var t=this.getProperty(e);return t&&t.get()},getValues:function(){var e=[],t=arguments,n=t.length,r,i;for(var s=0;s<n;s++)r=t[s],i=this.getValue(r),e.push(i);return e},getProperty:function(e){return this.properties[e]},property:function(e){return this.getProperty(e)},set:function(e,t){if(arguments.length>1)this.setValue(e,t);else{var n=e;this.setMap(n)}},setMap:function(t){t=t||{},e.forEach(t,function(e,t){this.setValue(t,e)},this)},setValue:function(e,t){var n=this.getProperty(e);n?n.set(t):this.initProperty(e,t)},setProperty:function(e,t){return this.unsetProperty(e),this.properties[e]=t,this.listenTo(t,h,this.change),t},unsetProperty:function(e){var t=this.properties[e];return t?(this.stopListening(t,h,this.change),delete this.properties[e],t):null}}),n.Items=n.extendClass(Array,n.Base.fn,{constructor:function(t){if(!(this instanceof n.Items))return n.createWithArguments(n.Items,arguments);Array.call(this),t&&this.set(n.toArray(t))},pop:function(){var e=i.pop.apply(this);return this.trigger(c,e),e},push:function(){var e=u(arguments),t;for(var n=0,r=e.length;n<r;n++)t=e[n],i.push.call(this,t),this.trigger(l,t,this.length);return this.length},shift:function(){var e=i.shift.apply(this);return this.trigger(c,e),e},sort:function(){var e=i.sort.apply(this,arguments);return this.trigger(p,this),e},splice:function(e,t){var n=u(arguments,2),r=0;return t>0&&(r=this.remove(e,t)),n.length&&this.insert.apply(this,[e].concat(n)),r},unshift:function(){var e=u(arguments),t;for(var n=0,r=e.length;n<r;n++)t=e[n],i.unshift.call(this,t),this.trigger(l,t,0);return this.length},remove:function(e,t){var n,r;arguments.length<1&&(e=0),arguments.length<2&&(t=this.length-e),n=[];while(e<this.length&&t-->0)r=this[e],i.splice.call(this,e,1),this.trigger(c,r),n.push(r);return n},empty:function(){return this.remove(),this.length},insert:function(e){var t=u(arguments,1),n,r;for(var s=0,o=t.length;s<o;s++)n=t[s],r=e+s,i.splice.call(this,r,0,n),this.trigger(l,n,r);return this.length},set:function(e){var t=u(e);return t.unshift(0),this.empty(),this.insert.apply(this,t),this.length},get:function(e){return arguments.length<1?this:(e<0&&(e=this.length+e),a(this,e)?this[e]:null)},toArray:function(){return n.toArray(this)}});var v=function(t,n,r){var i;return r=u(r),r.unshift(t),i=e[n].apply(e,r),i},m=["collect","compact","difference","filter","flatten","foldl","foldr","initial","inject","intersection","invoke","map","partition","pluck","reduceRight","reject","rest","select","shuffle","sortBy","union","uniq","unique","where","without","zip"];e.forEach(m,function(e){n.Items.fn[e]=function(){var t=v(this,e,arguments);return t=n.Items.create(t),t}});var g=["all","any","contains","countBy","detect","each","every","find","findWhere","forEach","groupBy","include","indexBy","indexOf","lastIndexOf","max","min","object","reduce","size","some","sortedIndex"];e.forEach(g,function(e){n.Items.fn[e]=function(){var t=v(this,e,arguments);return t}});var y=["sample","first","last"];return e.forEach(y,function(e){n.Items.fn[e]=function(){var t=v(this,e,arguments);return arguments.length>0&&(t=n.Items.create(t)),t}}),n.Items.create=n.createThis,n.Items.include=n.include,n.Items.extend=n.extendThisClass,n.Collection=n.Data.extend({items:null,length:0,defaultConstructor:n.Property,constructor:function(t){this.items=new n.Items,this.start(),t&&this.add(t),this.init()},start:function(){this.stop(),this.listenTo(this.items,l,this.triggerAdd),this.listenTo(this.items,c,this.triggerRemove),this.listenTo(this.items,p,this.triggerSort),this.listenTo(this.items,l,this.updateLength),this.listenTo(this.items,c,this.updateLength),this.listenTo(this.items,l,this.watchItem),this.listenTo(this.items,c,this.unwatchItem)},stop:function(){this.stopListening(this.items)},triggerAdd:function(e,t){this.trigger(l,e,t)},triggerRemove:function(e){this.trigger(c,e)},triggerSort:function(e){this.trigger(p,e)},triggerChange:function(e,t,n){this.trigger(h,e,t)},updateLength:function(){this.length=this.items.length},add:function(){var t=e.flatten(arguments);for(var n=0,r=t.length;n<r;n++)this.addItem(t[n],this.items.length)},addItem:function(e){var t=e,r;e instanceof n.Base||(r=this.getConstructor(e),e=new r(e));var i=this.identify(e);if(i)i.set(t);else{var s=this.findInsertIndex(e);this.items.insert(s+1,e)}},watchItem:function(e){this.listenTo(e,h,this.triggerChange)},unwatchItem:function(e){this.stopListening(e,h,this.triggerChange)},findInsertIndex:function(e){var t=-1;return this.items.forEach(function(n,r){if(this.comparator(n,e)<=0)return t=r,!1},this),t},getConstructor:function(e){return this.defaultConstructor},remove:function(e){var t=this.items,n=0;for(var r=0,i=t.length;r<i;r++)t[r]===e&&(t.splice(r,1),r--,n++);return n},empty:function(){return this.items.empty()},set:function(e){this.empty(),e&&this.add(e)},get:function(){var e=this.items.invoke("get");return e},identify:function(e){var t=this.items.contains(e);return t?e:null},comparator:function(e,t){return 0},sort:function(e){e&&(this.comparator=e),this.items.sort(this.comparator)},at:function(e){return this.items.get(e)}}),e.forEach(m,function(t){n.Collection.fn[t]=function(){var r,i=u(arguments);return i.unshift(this.items),r=e[t].apply(e,i),r=n.Items.create(r),r}}),e.forEach(g,function(t){n.Collection.fn[t]=function(){var n,r=u(arguments);return r.unshift(this.items),n=e[t].apply(e,r),n}}),e.forEach(y,function(t){n.Collection.fn[t]=function(){var r,i=u(arguments),s=i.length;return i.unshift(this.items),r=e[t].apply(e,i),s>0&&(r=n.Items.create(r)),r}}),n.Controller=n.Base.extend({constructor:function(){return n.Base.apply(this,arguments)}}),n},this);