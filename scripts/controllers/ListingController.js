define(["require","ok","underscore","bluebird","modules/sync","collections/Listing"],function(e){var t=e("ok"),n=e("underscore"),r=e("bluebird"),i=e("modules/sync"),s=e("collections/Listing"),o=t.Controller.extend({init:function(e){n.extend(this,n.pick(e,"listing","router")),n.bindAll(this,"resetState","loadMore","handleResponse","handleRouteSubreddit","handleRouteFrontpage","handleRouteUsername","handleRouteDomain","handleRouteMulti","handleRouteSearch"),this.params=new t.Map({after:null}),this.state=new t.Map({atEnd:!1,currentPage:null}),this.latestXhr=null,this.router.on("route:subreddit",this.handleRouteSubreddit),this.router.on("route:frontpage",this.handleRouteFrontpage),this.router.on("route:username",this.handleRouteUsername),this.router.on("route:multi",this.handleRouteMulti),this.router.on("route:domain",this.handleRouteDomain),this.router.on("route:search",this.handleRouteSearch)},resetState:function(){this.listing.empty(),this.resetParams(),this.state.set("atEnd",!1),this.state.set("currentPage",null),this.latestXhr&&(this.latestXhr.abort(),this.latestXhr=null)},resetParams:function(){n.forEach(this.params.properties,function(e){e.set(null)})},setParams:function(e){this.params.set(e)},loadMore:function(e){return e=n.extend({page:this.state.get("currentPage")},this.params.get(),e),this.state.get("atEnd")?r.reject(new Error("At end of listing")):(this.latestXhr&&this.latestXhr.abort(),this.latestXhr=i.getData(e),r.resolve(this.latestXhr).bind(this).catch(this.handleError).then(this.handleResponse),r.resolve(this.latestXhr))},reload:function(){this.listing.empty(),this.params.set("after",null),this.loadMore()},search:function(e){this.resetState(),this.setParams({q:e}),this.state.set("currentPage","/search"),this.loadMore()},handleError:function(e){console.log("Error fetching listing",e)},handleEnd:function(){console.log("End of listing reached")},handleResponse:function(e){var t=e.data.after;this.params.set("after",t),t||(this.state.set("atEnd",!0),this.handleEnd()),this.listing.add(e.data.children),this.trigger("listing")},handleRouteFrontpage:function(e,t){var n="/";e&&(n+=e),this.resetState(),this.setParams(t),this.state.set("currentPage",n),this.loadMore()},handleRouteSubreddit:function(e,t,n){var r="/r/"+e;t&&(r+="/"+t),this.resetState(),this.setParams(n),this.state.set("currentPage",r),this.loadMore()},handleRouteUsername:function(e,t){var n="/user/"+e;this.resetState(),this.setParams(t),this.state.set("currentPage",n),this.loadMore()},handleRouteMulti:function(e,t,n,r){var i="/user/"+e+"/m/"+t;n&&(i+="/"+n),this.resetState(),this.setParams(r),this.state.set("currentPage",i),this.loadMore()},handleRouteDomain:function(e,t,n){var r="/domain/"+e;t&&(r+="/"+t),this.resetState(),this.setParams(n),this.state.set("currentPage",r),this.loadMore()},handleRouteSearch:function(e){this.resetState(),this.setParams(e),this.state.set("currentPage","/search"),this.loadMore()}});return o});